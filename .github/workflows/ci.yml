name: CI - Unit Tests with Claude Feedback

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      id: pytest
      run: |
        set +e
        pytest -v --tb=short > test_output.txt 2>&1
        echo $? > pytest_exit_code.txt
        cat test_output.txt
        exit $(cat pytest_exit_code.txt)
      continue-on-error: true

    - name: Post Claude feedback on failure
      if: steps.pytest.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const testOutput = fs.readFileSync('test_output.txt', 'utf8');

          const issue_number = context.issue.number;
          if (issue_number) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `@Claude Unit tests failed. Please analyze and suggest a fix:\n\n\`\`\`\n${testOutput}\n\`\`\``
            });
          }

    - name: Fail job if tests failed
      if: steps.pytest.outcome == 'failure'
      run: exit 1
